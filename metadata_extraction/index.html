<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Metadata extraction - Traces Analyzer</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Metadata extraction";
        var mkdocs_page_input_path = "metadata_extraction.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Traces Analyzer
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../parsing/">Parsing</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Metadata extraction</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#goal">Goal</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#analysis">Analysis</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#instruction-effect-changes">Instruction effect changes</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#instruction-input-changes">Instruction input changes</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#instruction-usage">Instruction usage</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#not-yet-covered">Not yet covered</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#taint-flow-analysis">Taint Flow analysis</a>
    </li>
    </ul>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Traces Analyzer</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Metadata extraction</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="metadata-extraction">Metadata extraction</h1>
<p>This page describes how metadata will be extracted from the traces.</p>
<h2 id="goal">Goal</h2>
<p>Based on the four transaction traces (2 normal, 2 reverse order), we automatically determine several labels and metadata related to TOD.</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>This does not detect if the amount of a Selfedestruct changed, as this is directly taken from the state and not stored in the stack or memory. Are there other TODs that are not visible in traces?</p>
</div>
<h2 id="analysis">Analysis</h2>
<p>The analyzers are built in a way, that they don't need access to the whole trace at once. This way, we do not need to load the whole trace into memory at the same time, but instead iterate through the events and analyze them on the go. This is mainly a memory improvement.</p>
<h3 id="instruction-effect-changes">Instruction effect changes</h3>
<p>To understand, where the TOD occurs we compare the transaction trace from the normal and attack executions. At each iteration, we compare the <code>Instruction</code>s and stop as soon as we find the TOD source.</p>
<p>If two instructions have a different output (eg an <code>SLOAD</code> that loads a different value from storage), we consider them to be the TOD source.</p>
<p>If this did not happen yet, but two instructions differ otherwise (inputs, program counter, etc), we take the previous instructions as TOD source. For example, this can happen if a <code>CALL</code> occurs and in one trace there is enough balance to do this, while the other trace has insufficient balance to do so.</p>
<p><strong>Requires</strong>:</p>
<ul>
<li>comparison of two traces</li>
<li>access to <code>Instruction</code>s</li>
</ul>
<p><strong>Labels</strong>:</p>
<ul>
<li>TOD-source-instruction</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Check if this also works for reverts.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There could be multiple instructions that are directly affected by the previous transaction, however for all but the first instruction, it is hard to differentiate between a direct effect of the previous transaction, or an indirect effect through the first divergent instruction.</p>
</div>
<h3 id="instruction-input-changes">Instruction input changes</h3>
<p>To understand, which instructions are affected by the TOD, we compare if the same instructions were executed, and if they were given the same inputs.</p>
<p>For each instruction we count how often it has been exected in each trace. We identify the instruction by the code_address, pc, opcode and inputs. For instructions in trace A, we increment the counter. For instructions in the other trace, decrement it. Thus, if the instruction occurs in both traces, the count will balance to 0. If the inputs differ, we will have two different elements, one with a +1 count and one with -1.</p>
<p>At the end, we group the instructions only by code_address, pc and opcode, so instructions with different inputs will be grouped together. These are matched between the traces to identify which parameters have changed and outputted as such. If no match exists, we output them as only being executed by one trace.</p>
<p><strong>Requires</strong>:</p>
<ul>
<li>comparison of two traces</li>
<li>access to <code>Instruction</code>s</li>
</ul>
<p><strong>Labels</strong>:</p>
<ul>
<li>TOD-Amount, TOD-Recipient, TOD-Selfdestruct, (TOD-Transfer also uses <code>CALL</code>)</li>
<li>ether profits</li>
<li>list of affected instructions</li>
</ul>
<p>If this includes inputs from the memory, further:</p>
<ul>
<li>call input changes</li>
<li>log changes</li>
<li>token profits (through log changes)</li>
</ul>
<h3 id="instruction-usage">Instruction usage</h3>
<p>We record all executed unique instructions, eg to understand if hashing was used. We group this by the contract address that executed them.</p>
<p><strong>Requires</strong>:</p>
<ul>
<li>access to <code>Instruction</code>s</li>
<li>access to <code>CallFrame</code>s</li>
</ul>
<p><strong>Labels</strong>:</p>
<ul>
<li>cryptography usage (hashing, signatures)</li>
<li>usage of recently introduce opcodes</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Solidity uses <code>keccak256</code> internally for mappings. Some detection tools based on the source code may understand Solidity mappings, but not usage of <code>keccak256</code> in other cases.</p>
</div>
<h2 id="not-yet-covered">Not yet covered</h2>
<ul>
<li>usage of precompiled contracts (see <a href="https://www.evm.codes/precompiled">https://www.evm.codes/precompiled</a>)</li>
<li>attacker-preconditions (eg. if the address from the attacker was returned from a SLOAD or a SLOAD with the attackers address as index returned != 0? Hard to understand without information flow analysis)</li>
<li>control flow differences (where and through what? implement eg with changes or by comparing instructions)</li>
<li>attack symmetry (if the order was different, would the "victim" be an "attacker"?)</li>
<li>output differences (particularly useful, if we group by instruction+inputs =&gt; sampe input that yields different output is probably TOD affected)</li>
</ul>
<h2 id="taint-flow-analysis">Taint Flow analysis</h2>
<p>We could also do taint flow analysis with a few modifications. If we replace the string values on the stack, memory and calldata with objects that store <code>(value, written_by: Instruction and read_by: list[Instruction])</code>, then we would know which write did affect which reads and thus which instructions influenced which following instructions.</p>
<p>This could be used for:
- checking if the attackers address was used for some check (if conditions) or influenced the sink (both, directly or through sstore-&gt;sload/tstore-&gt;tload/...)
- to reduce the number of vulnerable accounts in one source-&gt;sink flow (if we know the flow we know exactly which contracts are involved, instead of relying on heuristics that potentially include too many)</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../parsing/" class="btn btn-neutral float-left" title="Parsing"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../parsing/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
