<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Parsing - Traces Analyzer</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Parsing";
        var mkdocs_page_input_path = "parsing.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Traces Analyzer
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Parsing</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#traces-input">Traces input</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#map-each-json-to-a-traceevent">Map each JSON to a TraceEvent</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#parse-instructions-and-the-calltree">Parse Instructions and the CallTree</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../metadata_extraction/">Metadata extraction</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Traces Analyzer</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Parsing</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="parsing">Parsing</h1>
<h2 id="traces-input">Traces input</h2>
<p>As inputs we take the execution traces from the transactions. These are based on the non-finalized <a href="https://eips.ethereum.org/EIPS/eip-3155">EIP-3155</a> EVM trace specification.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We require the "pc", "op", "stack" and "depth" fields. For better instruction input and output analysis, the "memory" field should also be present, eg to identify the CALL and LOG inputs.</p>
</div>
<p>Here is an example trace for an SLOAD instruction:</p>
<pre><code class="language-json">{
  &quot;pc&quot;: 1157,
  &quot;op&quot;: 84,
  &quot;gas&quot;: &quot;0x1f7b1&quot;,
  &quot;gasCost&quot;: &quot;0x834&quot;,
  &quot;stack&quot;: [
    &quot;0xd0e30db0&quot;,
    &quot;...&quot;,
    &quot;0xd7a8b5b72b22ea76954784721def9efafa7df99d65b759e7d1b78f9ee0094fbc&quot;
  ],
  &quot;memory&quot;: &quot;0x00..080&quot;,
  &quot;depth&quot;: 2,
  &quot;returnData&quot;: &quot;0x&quot;,
  &quot;refund&quot;: &quot;0x0&quot;,
  &quot;memSize&quot;: &quot;96&quot;,
  &quot;opName&quot;: &quot;SLOAD&quot;
}
</code></pre>
<h2 id="map-each-json-to-a-traceevent">Map each JSON to a <code>TraceEvent</code></h2>
<p>This step simply maps a trace event from JSON to a python class (<code>TraceEvent</code>).</p>
<p>Currently this is only implemented for traces generated with REVM (based on EIP-3155). However, new implementations could map other traces formats to <code>TraceEvent</code>, as long as the necessary information is included in the trace.</p>
<h2 id="parse-instructions-and-the-calltree">Parse <code>Instruction</code>s and the <code>CallTree</code></h2>
<p>Here, we parse the instructions and keep track in which contract they were executed.</p>
<p>We start the process with an initial <code>CallFrame</code>, which stores who created the transaction and which contract/EOA is called.</p>
<p>Then we iterate through the <code>TraceEvent</code>s, always looking at two successive <code>TraceEvent</code>s. Based on these events we create an <code>Instruction</code> object, which specifies the EVM instruction, its inputs and also its outputs. For some instructions the call context is important, so we link the current <code>CallFrame</code> to the instruction. For instance, an <code>SLOAD</code> instruction loads the data from the current contracts storage.</p>
<p>If we encounter a call instruction (<code>CALL</code>, <code>STATICCALL</code>, <code>CALLCODE</code>, <code>DELEGATECALL</code>, <code>CREATE</code> or <code>CREATE2</code>) we create a new <code>CallFrame</code>. On a <code>STOP</code>, <code>RETURN</code>, <code>REVERT</code> or <code>SELFDESTRUCT</code> we mark the current one as reverted and go back to the previous <code>CallFrame</code>. If the depth of the next event is one lower than the current one, we assume an exceptional halt and also revert the current transaction. If the depth of the next event is unexpected, we throw an <code>UnexpectedDepthChange</code> Exception.</p>
<p>The <code>Instruction</code> includes:</p>
<ul>
<li>opcode</li>
<li>name (mnemonic for opcode)</li>
<li>program_counter</li>
<li>call_frame</li>
<li>stack_inputs</li>
<li>stack_outputs</li>
<li>memory_input</li>
<li>memory_output</li>
<li>data (additional fields based on the instruction type, eg <code>key</code> for <code>SLOAD</code>)</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="Introduction"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../metadata_extraction/" class="btn btn-neutral float-right" title="Metadata extraction">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../metadata_extraction/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
